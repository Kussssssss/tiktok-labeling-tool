<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Video Labeling Tool v2.2</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎥 TikTok Vido Labeling Tool <span class="version-badge">v2.2</span></h1>
            <p>Công cụ gắn nhãn video TikTok chuyên nghiệp với giao diện được tối ưu</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 5px;">✨ Tính năng mới: File mẫu để test và hỗ trợ CSV đơn giản (chỉ cần username, id_video)</p>
            <div style="position: absolute; top: 18px; right: 32px;">
                <button id="themeToggleBtn" title="Chuyển chế độ sáng/tối" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">🌙</button>
            </div>
        </div>

        <!-- Thông báo phím tắt -->
        <div id="shortcutHint" style="background: #e6f7ff; color: #222; border: 1.5px solid #91d5ff; border-radius: 10px; padding: 14px 18px; margin: 0 auto 18px auto; max-width: 700px; font-size: 1.04em; display: flex; align-items: center; gap: 12px; position: relative;">
            <span style="font-size:1.3em;">⌨️</span>
            <span><b>Mẹo:</b> Bạn có thể sử dụng các <b>phím tắt</b> để gắn nhãn nhanh:
                <br>
                <span style="display:inline-block;margin-top:2px;">
                    <b>Ctrl+1</b> (Harmful), <b>Ctrl+2</b> (Suicide), <b>Ctrl+3</b> (Adult), <b>Ctrl+4</b> (Safe), <b>Ctrl+5</b> (Confuse), <b>Ctrl+6</b> (Empty), <b>Ctrl+S</b> (Xuất CSV), <b>←</b>/<b>→</b> (chuyển video)
                </span>
                <br>
                <span style="display:inline-block;margin-top:4px;font-size:0.9em;color:#666;">
                    💡 <b>Bắt đầu:</b> Chọn "File mẫu" để test (lưu tạm thời) hoặc upload file CSV thực
                </span>
            </span>
            <button onclick="document.getElementById('shortcutHint').style.display='none'" style="position:absolute;top:8px;right:12px;background:none;border:none;font-size:1.2em;cursor:pointer;color:#888;">✖</button>
        </div>

        <!-- Guideline Section -->
        <div class="upload-section guideline-section" id="guidelineSection">
            <h3>📚 Hướng dẫn gắn nhãn (Guideline)</h3>
            <div id="guidelineCards" style="display: flex; flex-wrap: wrap; gap: 16px;"></div>
            <div id="guidelineNote" style="margin-top: 16px; color: #d48806; font-size: 0.95em;"></div>
        </div>

        <div class="upload-section">
            <div class="file-selection-container">
                <h3>📂 Chọn dữ liệu để gắn nhãn</h3>
                
                <!-- File Selection Options -->
                <div class="file-options">
                    <div class="file-option">
                        <div class="option-header">
                            <span class="option-icon">🎯</span>
                            <span class="option-title">File mẫu (Test)</span>
                        </div>
                        <div class="option-description">
                            Sử dụng file <code>100samples.csv</code> có sẵn để test thử ứng dụng
                        </div>
                        <button onclick="loadSampleFile()" class="sample-btn">
                            🚀 Tải file mẫu
                        </button>
                    </div>
                    
                    <div class="file-option">
                        <div class="option-header">
                            <span class="option-icon">📁</span>
                            <span class="option-title">Upload file CSV</span>
                        </div>
                        <div class="option-description">
                            Upload file CSV của bạn với định dạng: <code>username,id_video</code> (các cột khác sẽ được tạo tự động)
                        </div>
                        <div class="file-input-wrapper">
                            <input type="file" id="csvFile" accept=".csv" />
                            📁 Chọn file CSV
                        </div>
                    </div>
                </div>
                
                <!-- File Format Guide -->
                <div class="format-guide">
                    <details>
                        <summary>📋 Hướng dẫn định dạng file CSV</summary>
                        <div class="format-content">
                            <p><strong>File CSV cần có các cột sau:</strong></p>
                            <ul>
                                <li><code>username</code>: Tên người dùng TikTok (bắt buộc)</li>
                                <li><code>id_video</code>: ID video TikTok (bắt buộc)</li>
                            </ul>
                            <p><strong>Các cột khác sẽ được tạo tự động:</strong></p>
                            <ul>
                                <li><code>Safe</code>: Nội dung an toàn (true/false)</li>
                                <li><code>Suicide</code>: Nội dung tự sát (true/false)</li>
                                <li><code>Adult Content</code>: Nội dung người lớn (true/false)</li>
                                <li><code>Harmful Content</code>: Nội dung có hại (true/false)</li>
                                <li><code>confuse</code>: Phân vân (true/false)</li>
                                <li><code>Empty</code>: Không khả dụng (true/false)</li>
                            </ul>
                            <p><strong>Ví dụ:</strong></p>
                            <pre>username,id_video
"user1","1234567890"
"user2","0987654321"</pre>
                            <p><strong>Hoặc với đầy đủ cột (tùy chọn):</strong></p>
                            <pre>username,id_video,Safe,Suicide,Adult Content,Harmful Content,confuse,Empty
"user1","1234567890","false","false","false","false","false","false"
"user2","0987654321","true","false","false","false","false","false"</pre>
                        </div>
                    </details>
                </div>
            </div>
            
            <button onclick="exportCSV()" class="export-btn" style="display:none; width: auto; padding: 8px 16px; margin-left: 12px; font-size: 0.9em;" id="exportBtn">
                💾 Xuất CSV
            </button>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div id="totalVideos">0</div>
                    <div>Tổng video</div>
                </div>
                <div class="stat-card">
                    <div id="labeledVideos">0</div>
                    <div>Đã gắn nhãn</div>
                </div>
                <div class="stat-card">
                    <div id="progressPercent">0%</div>
                    <div>Tiến độ</div>
                </div>
                <div class="stat-card" id="fileModeCard" style="display: none;">
                    <div id="fileMode">📁</div>
                    <div id="fileModeText">Chế độ</div>
                </div>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Video List - Left Column -->
            <div class="video-list">
                <h3>📋 Danh sách video</h3>
                <div class="video-list-container" id="videoListContainer"></div>
            </div>

            <!-- Player Section - Center Column -->
            <div class="player-section">
                <div class="current-video-info" id="currentVideoInfo">
                    Chọn một video để bắt đầu
                </div>

                <div class="navigation-buttons">
                    <button class="nav-btn prev" onclick="previousVideo()">⬅️ Trước</button>
                    <button class="nav-btn next" onclick="nextVideo()">Tiếp ➡️</button>
                </div>
                
                <!-- Video player container -->
                <div id="videoPlayerContainer" class="video-player-container" style="display: none;">
                    <!-- TikTok embed sẽ được render ở đây -->
                </div>

                <!-- Accordion for embed methods -->
                <div class="accordion" id="embedAccordion">
                    <div class="accordion-header" id="accordionHeader">
                        <span>🔧 Các phương pháp nhúng video</span>
                        <span class="arrow">▼</span>
                    </div>
                    <div class="accordion-content" id="accordionContent">
                        <div class="video-tabs">
                            <button class="tab-btn active" onclick="switchTab('smart', event)">🎯 Smart</button>
                            <button class="tab-btn" onclick="switchTab('oembed', event)">🎬 oEmbed</button>
                            <button class="tab-btn" onclick="switchTab('blockquote', event)">📺 Block</button>
                            <button class="tab-btn" onclick="switchTab('external', event)">🔗 Link</button>
                        </div>

                        <!-- Smart Auto Tab -->
                        <div id="smartTab" class="tab-content active">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="smartLoadVideo()">
                                    🚀 Tự động tìm cách tốt nhất
                                </button>
                            </div>
                            <div id="smartContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">🎯</div>
                                    <div>Smart Auto sẽ tự động thử các phương pháp embed</div>
                                    <div class="placeholder-note">Blockquote → oEmbed → External backup</div>
                                </div>
                            </div>
                        </div>

                        <!-- oEmbed Tab -->
                        <div id="oembedTab" class="tab-content">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="loadOEmbed()">🚀 Tải qua oEmbed</button>
                                <button class="embed-btn" onclick="tryOEmbedProxy()">🔄 Thử Proxy</button>
                            </div>
                            <div id="oembedContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">🎬</div>
                                    <div>TikTok oEmbed API</div>
                                    <div class="placeholder-note">Phương thức chính thức từ TikTok</div>
                                </div>
                            </div>
                        </div>

                        <!-- Blockquote Tab -->
                        <div id="blockquoteTab" class="tab-content">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="loadBlockquote()">📺 Embed</button>
                                <button class="embed-btn" onclick="forceReloadScript()">🔄 Reload</button>
                            </div>
                            <div id="blockquoteContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">📺</div>
                                    <div>TikTok Blockquote</div>
                                    <div class="placeholder-note">Native embed method</div>
                                </div>
                            </div>
                        </div>

                        <!-- External Tab -->
                        <div id="externalTab" class="tab-content">
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <button id="openTikTokBtn" style="flex: 1; background: #ff0050; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em;">
                                    📱 Xem Video
                                </button>
                                <button id="copyUrlBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                    📋
                                </button>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-size: 0.8em; margin-bottom: 6px; opacity: 0.9;">🔗 URL Public:</div>
                                <div id="videoUrl" style="font-family: monospace; font-size: 0.75em; word-break: break-all; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                                    https://www.tiktok.com/@tiktok/video/7196733917032877354
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel - Right Column -->
            <div class="controls-panel">
                <div class="labeling-controls">
                    <h3>🏷️ Gắn nhãn</h3>
                    <div class="label-groups" id="labelingControls" style="display: none; flex-direction: column; gap: 18px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 14px; justify-content: center;">
                            <button class="label-btn harmful" title="Ctrl+1: Nội dung có hại" onclick="setLabel('Harmful Content')">
                                <span class="label-icon">🚫</span>
                                <span class="label-text">Harmful<br><small>(Ctrl+1)</small></span>
                            </button>
                            <button class="label-btn suicide" title="Ctrl+2: Tự sát" onclick="setLabel('Suicide')">
                                <span class="label-icon">🆘</span>
                                <span class="label-text">Suicide<br><small>(Ctrl+2)</small></span>
                            </button>
                            <button class="label-btn adult" title="Ctrl+3: Nội dung người lớn" onclick="setLabel('Adult Content')">
                                <span class="label-icon">🔞</span>
                                <span class="label-text">Adult<br><small>(Ctrl+3)</small></span>
                            </button>
                            <button class="label-btn safe" title="Ctrl+4: An toàn" onclick="setLabel('Safe')">
                                <span class="label-icon">✅</span>
                                <span class="label-text">Safe<br><small>(Ctrl+4)</small></span>
                            </button>
                            <button class="label-btn confuse" title="Ctrl+5: Phân vân" onclick="setLabel('confuse')">
                                <span class="label-icon">🤔</span>
                                <span class="label-text">Confuse<br><small>(Ctrl+5)</small></span>
                            </button>
                            <button class="label-btn empty" title="Ctrl+6: Không khả dụng" onclick="setLabel('Empty')">
                                <span class="label-icon">❌</span>
                                <span class="label-text">Empty<br><small>(Ctrl+6)</small></span>
                            </button>
                            </div>
                        <div style="margin-top: 10px; text-align: center;">
                            <label style="font-size: 0.98em; cursor: pointer;">
                                <input type="checkbox" id="autoNextToggle" style="margin-right: 6px; vertical-align: middle;"> Tự động chuyển video tiếp theo sau khi gắn nhãn
                            </label>
                            </div>
                        <div style="margin-top: 18px; text-align: center;">
                            <button class="export-btn" onclick="exportCSV()" id="exportBtn2">💾 Xuất kết quả CSV</button>
                            </div>
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="corsWarning" style="display:none;position:fixed;bottom:18px;right:18px;z-index:9999;background:#fff3cd;color:#856404;padding:12px 18px;border-radius:8px;box-shadow:0 2px 8px #0002;font-size:0.95em;border:1px solid #ffeeba;max-width:340px;">
        ⚠️ Một số lỗi CORS từ TikTok embed là bình thường và không ảnh hưởng chức năng gắn nhãn.<br>
        <span style="font-size:0.85em;">(Chỉ hiển thị cho dev/admin)</span>
    </div>

    <script>
        // Global variables
        let csvData = [];
        let currentVideoIndex = 0;
        let currentVideoId = null;
        let currentVideoUrl = null;
        let currentPlayerUrl = null;
        let embedScriptLoaded = false;
        let fileHandle = null;
        let lastSaveTime = null;
        let originalFile = null;
        let hasUnsavedChanges = false;
        let permissionRequested = false;
        let isProcessingFile = false;
        let isSampleFile = false; // Flag to identify if using sample file

        // Add data backup variables at the top of the script
        let originalCsvContent = null;
        let initialDataLoaded = false;

        // Add auto-save optimization variables
        let saveBuffer = [];
        let lastSaveOperation = null;
        let saveTimeout = null;
        const SAVE_DELAY = 1000; // 1 second
        const MAX_BUFFER_SIZE = 3; // Save after 3 changes
        const AUTO_SAVE_INTERVAL = 300000; // 5 minutes

        // Add permission request dialog
        function showPermissionDialog() {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.className = 'permission-dialog';
                dialog.style.position = 'fixed';
                dialog.style.top = '50%';
                dialog.style.left = '50%';
                dialog.style.transform = 'translate(-50%, -50%)';
                dialog.innerHTML = `
                    <h3>Yêu cầu quyền truy cập file</h3>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        Để tự động lưu các thay đổi, chúng tôi cần quyền truy cập vào file của bạn.<br>
                        Nếu bạn từ chối, các thay đổi sẽ được lưu tạm thời và bạn cần xuất file thủ công.
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="denyPermission">Từ chối</button>
                        <button id="grantPermission">Đồng ý</button>
                    </div>
                `;

                // Add overlay
                const overlay = document.createElement('div');
                overlay.className = 'permission-overlay';

                document.body.appendChild(overlay);
                document.body.appendChild(dialog);

                // Handle button clicks
                document.getElementById('grantPermission').onclick = () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                    resolve(true);
                };

                document.getElementById('denyPermission').onclick = () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                    resolve(false);
                };
            });
        }

        // Modify file input handler
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (isProcessingFile) {
                showNotification('⚠️ Đang xử lý file, vui lòng đợi...', 'error');
                return;
            }

            isProcessingFile = true;

            try {
                // Reset previous data
                csvData = [];
                fileHandle = null;
                originalFile = file;
                hasUnsavedChanges = false;
                permissionRequested = false;
                isSampleFile = false; // Mark as real file upload

                // Read and store original content
                originalCsvContent = await readFileContent(file);
                if (!originalCsvContent) {
                    throw new Error('Không thể đọc nội dung file');
                }

                // Parse CSV data
                parseCSV(originalCsvContent);
                initialDataLoaded = true;

                // Request permission if not already requested
                if (!permissionRequested) {
                    const granted = await showPermissionDialog();
                    permissionRequested = true;

                    if (granted) {
                        try {
                            fileHandle = await window.showSaveFilePicker({
                                suggestedName: file.name,
                                types: [{
                                    description: 'CSV Files',
                                    accept: {'text/csv': ['.csv']},
                                }],
                            });

                            // Immediately save the original content to the new file
                            if (initialDataLoaded && originalCsvContent) {
                                const writable = await fileHandle.createWritable();
                                await writable.write(originalCsvContent);
                                await writable.close();
                                showNotification('📂 Đã tải và lưu file CSV thành công!', 'success');
                            } else {
                                throw new Error('Dữ liệu ban đầu không hợp lệ');
                            }
                        } catch (error) {
                            console.warn('Không thể lưu file:', error);
                            showNotification('⚠️ Không thể lưu file. Dữ liệu sẽ được lưu tạm thời.', 'error');
                            fileHandle = null;
                        }
                    } else {
                        showNotification('ℹ️ Bạn có thể xuất file thủ công khi cần.', 'success');
                    }
                }
            } catch (error) {
                showNotification('❌ Lỗi khi xử lý file: ' + error.message, 'error');
                resetUI();
            } finally {
                isProcessingFile = false;
            }
        });

        // Helper function to reset UI
        function resetUI() {
            document.getElementById('stats').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('videoListContainer').innerHTML = '';
            document.getElementById('currentVideoInfo').innerHTML = 'Chọn một video để bắt đầu';
            document.getElementById('videoPlayerContainer').style.display = 'none';
            document.getElementById('labelingControls').style.display = 'none';
        }

        // Helper function to read file content
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        resolve(e.target.result);
                    } catch (error) {
                        reject(new Error('Lỗi khi đọc nội dung file: ' + error.message));
                    }
                };
                reader.onerror = (e) => {
                    reject(new Error('Lỗi khi đọc file: ' + (e.target.error?.message || 'Unknown error')));
                };
                reader.readAsText(file);
            });
        }

        // Parse CSV data with better error handling
        function parseCSV(csv) {
            try {
                const lines = csv.split('\n');
                if (lines.length < 2) {
                    showNotification('❌ File CSV không có dữ liệu (ít hơn 2 dòng)!', 'error');
                    throw new Error('File CSV không có dữ liệu');
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                if (headers.length === 0) {
                    showNotification('❌ File CSV không có header!', 'error');
                    throw new Error('File CSV không có header');
                }

                // Check required columns
                const requiredColumns = ['username', 'id_video'];
                const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                if (missingColumns.length > 0) {
                    showNotification(`❌ File CSV thiếu cột bắt buộc: ${missingColumns.join(', ')}`, 'error');
                    throw new Error(`Thiếu cột bắt buộc: ${missingColumns.join(', ')}`);
                }

                // Define all possible columns
                const allColumns = ['username', 'id_video', 'Safe', 'Suicide', 'Adult Content', 'Harmful Content', 'confuse', 'Empty'];
                
                csvData = [];
                let errorLines = [];
                let validLineCount = 0;
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    try {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        const row = {};
                        
                        // Process existing columns
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        // Add missing columns with default values
                        allColumns.forEach(col => {
                            if (!row.hasOwnProperty(col)) {
                                row[col] = 'false';
                            }
                        });
                        
                        csvData.push(row);
                        validLineCount++;
                    } catch (error) {
                        errorLines.push(i + 1);
                        console.warn(`Lỗi ở dòng ${i + 1}:`, error);
                    }
                }

                // Lưu lại số dòng hợp lệ ban đầu để kiểm tra khi lưu/export
                window._originalCsvLineCount = validLineCount;

                if (csvData.length === 0) {
                    showNotification('❌ Không có dữ liệu hợp lệ trong file CSV!', 'error');
                    throw new Error('Không có dữ liệu hợp lệ trong file CSV');
                }
                if (csvData.length < 1) {
                    showNotification('❌ File CSV không có dòng dữ liệu!', 'error');
                    throw new Error('File CSV không có dòng dữ liệu!');
                }

                if (errorLines.length > 0) {
                    showNotification(`⚠️ Có ${errorLines.length} dòng không hợp lệ (${errorLines.join(', ')})`, 'error');
                }

                displayVideoList();
                updateStats();
                document.getElementById('stats').style.display = 'flex';
                document.getElementById('progressBar').style.display = 'block';
                document.getElementById('mainContent').style.display = 'grid';
                document.getElementById('exportBtn').style.display = 'inline-block';
                
                if (csvData.length > 0) {
                    autoLoadFirstVideo();
                }
            } catch (error) {
                resetUI();
                throw new Error('Lỗi khi xử lý CSV: ' + error.message);
            }
        }

        function autoLoadFirstVideo() {
            try {
                loadVideo(0);
                setTimeout(() => {
                    switchTab('smart', null);
                    smartLoadVideo();
                }, 200);
            } catch (error) {
                showNotification('❌ Lỗi khi tải video đầu tiên: ' + error.message, 'error');
            }
        }

        function displayVideoList() {
            try {
                const container = document.getElementById('videoListContainer');
                container.innerHTML = '';
                
                csvData.forEach((row, index) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    videoItem.onclick = () => loadVideo(index);
                    
                    const labels = [];
                    if (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1') {
                        labels.push('<span class="label-tag active">Harmful</span>');
                    }
                    if (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1') {
                        labels.push('<span class="label-tag active">Suicide</span>');
                    }
                    if (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1') {
                        labels.push('<span class="label-tag active">Adult</span>');
                    }
                    if (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1') {
                        labels.push('<span class="label-tag safe">Safe</span>');
                    }
                    if (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1') {
                        labels.push('<span class="label-tag">Confuse</span>');
                    }
                    if (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1') {
                        labels.push('<span class="label-tag" style="background: #dc3545;">Empty</span>');
                    }
                    if (labels.length === 0) {
                        labels.push('<span class="label-tag" style="background: #6c757d; opacity: 0.7;">Chưa gắn nhãn</span>');
                    }

                    videoItem.innerHTML = `
                        <div class="video-info">
                            <div class="video-filename">${row.username || ''} <span style='color:#888; font-size: 0.85em;'>(${row.id_video})</span></div>
                            <div class="video-labels">${labels.join('')}</div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.85em; min-width: 30px; text-align: right;">#${index + 1}</div>
                    `;
                    container.appendChild(videoItem);
                });
            } catch (error) {
                showNotification('❌ Lỗi khi hiển thị danh sách video: ' + error.message, 'error');
            }
        }

        // Load a specific video by index
        function loadVideo(index) {
            try {
                if (index < 0 || index >= csvData.length) {
                    throw new Error('Index video không hợp lệ');
                }

                currentVideoIndex = index;
                const row = csvData[index];
                const videoId = row.id_video;
                
                if (!videoId) {
                    throw new Error('Không tìm thấy ID video');
                }

                currentVideoId = videoId;
                
                // Update active state in video list
                document.querySelectorAll('.video-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });

                // Update video info display
                document.getElementById('currentVideoInfo').innerHTML = `
                    <strong>Video ${index + 1} / ${csvData.length}</strong><br>
                    <small>${row.username || ''} (${row.id_video})</small>
                `;

                // Setup video URLs
                const publicUrl = `https://www.tiktok.com/@tiktok/video/${videoId}`;
                const playerUrl = `https://www.tiktok.com/player/v1/${videoId}?autoplay=1&controls=1`;
                
                currentVideoUrl = publicUrl;
                currentPlayerUrl = playerUrl;
                
                const urlDisplay = document.getElementById('videoUrl');
                if (urlDisplay) urlDisplay.textContent = publicUrl;

                // Setup button handlers
                const openBtn = document.getElementById('openTikTokBtn');
                const copyBtn = document.getElementById('copyUrlBtn');

                if (openBtn) {
                    openBtn.onclick = () => {
                        window.open(publicUrl, '_blank');
                        openBtn.textContent = '✅ Đã mở!';
                        setTimeout(() => {
                            openBtn.textContent = '📱 Xem Video';
                        }, 2000);
                    };
                }

                if (copyBtn) {
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(publicUrl).then(() => {
                            copyBtn.textContent = '✅';
                            setTimeout(() => {
                                copyBtn.textContent = '📋';
                            }, 1500);
                        }).catch(() => {
                            const textArea = document.createElement('textarea');
                            textArea.value = publicUrl;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            copyBtn.textContent = '✅';
                            setTimeout(() => {
                                copyBtn.textContent = '📋';
                            }, 1500);
                        });
                    };
                }

                // Reset containers and show player
                resetAllContainers();
                const playerContainer = document.getElementById('videoPlayerContainer');
                playerContainer.style.display = 'flex';

                // Render TikTok blockquote in player container
                playerContainer.innerHTML = `
                    <blockquote class="tiktok-embed" cite="${publicUrl}" data-video-id="${videoId}" style="max-width: 100%; min-width: 300px; margin: 0 auto;">
                        <section>
                            <a target="_blank" href="${publicUrl}">Xem video TikTok này</a>
                        </section>
                    </blockquote>
                `;

                // Load TikTok embed script
                setTimeout(() => {
                    const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
                    if (existingScript) existingScript.remove();
                    const script = document.createElement('script');
                    script.src = 'https://www.tiktok.com/embed.js';
                    script.async = true;
                    document.head.appendChild(script);
                }, 100);

                // Load current labels
                const harmfulCheckbox = document.getElementById('harmfulContent');
                const suicideCheckbox = document.getElementById('suicide');
                const adultCheckbox = document.getElementById('adultContent');
                const safeCheckbox = document.getElementById('safe');
                const confuseCheckbox = document.getElementById('confuse');
                const emptyCheckbox = document.getElementById('empty');

                if (harmfulCheckbox) harmfulCheckbox.checked = (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1');
                if (suicideCheckbox) suicideCheckbox.checked = (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1');
                if (adultCheckbox) adultCheckbox.checked = (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1');
                if (safeCheckbox) safeCheckbox.checked = (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1');
                if (confuseCheckbox) confuseCheckbox.checked = (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1');
                if (emptyCheckbox) emptyCheckbox.checked = (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1');

                document.getElementById('labelingControls').style.display = 'flex';
                updateNavigationButtons();
                updateLabelButtonUI(row);
            } catch (error) {
                showNotification('❌ Lỗi khi tải video: ' + error.message, 'error');
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            // Xóa script TikTok cũ để tránh lỗi render
            const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
            if (existingScript) existingScript.remove();
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            else {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tabName)) btn.classList.add('active');
                });
            }
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Smart Auto Method
        async function smartLoadVideo() {
            if (!currentVideoUrl) return;
            const container = document.getElementById('smartContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Try blockquote first
                const blockquoteResult = await tryBlockquoteMethod();
                if (blockquoteResult.success) {
                    container.innerHTML = blockquoteResult.html;
                    await loadEmbedScript();
                    setTimeout(() => { forceReloadScript(); }, 200);
                    return;
                }

                // Try oEmbed
                const oembedResult = await tryOEmbedMethod();
                if (oembedResult.success) {
                    container.innerHTML = oembedResult.html;
                    await loadEmbedScript();
                    return;
                }

                // Fallback to external
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 2em; margin-bottom: 12px;">🔗</div>
                        <div><strong>Embed không khả dụng</strong></div>
                        <div style="margin: 12px 0; font-size: 0.9em;">Không thể nhúng video này. Vui lòng xem trực tiếp trên TikTok.</div>
                        <button onclick="window.open('${currentVideoUrl}', '_blank')" style="padding: 8px 16px; background: #ff0050; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight:600; font-size:0.9em;">
                            Mở video trên TikTok
                        </button>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 2em; margin-bottom: 12px;">❌</div>
                        <div>Lỗi khi tự động tải video</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Thử các tab khác hoặc dùng External</div>
                    </div>
                `;
            }
        }

        // Helper methods
        async function tryBlockquoteMethod() {
            // Tạo blockquote tạm thời, kiểm tra sau 1.2s xem có iframe TikTok xuất hiện không
            return new Promise((resolve) => {
                const testId = 'test-tiktok-blockquote';
                const temp = document.createElement('div');
                temp.style.display = 'none';
                temp.innerHTML = `
                    <blockquote class="tiktok-embed" cite="${currentVideoUrl}" data-video-id="${currentVideoId}">
                        <section>
                            <a target="_blank" href="${currentVideoUrl}">Xem video TikTok này</a>
                        </section>
                    </blockquote>
                `;
                temp.id = testId;
                document.body.appendChild(temp);

                // Nạp script
                const script = document.createElement('script');
                script.src = 'https://www.tiktok.com/embed.js';
                script.async = true;
                script.onload = () => {
                    setTimeout(() => {
                        const iframe = temp.querySelector('iframe');
                        document.body.removeChild(temp);
                        if (iframe) {
                            resolve({ success: true, html: temp.innerHTML });
                        } else {
                            resolve({ success: false });
                        }
                    }, 1200);
                };
                document.head.appendChild(script);
            });
        }

        async function tryOEmbedMethod() {
            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const response = await fetch(oembedUrl);
                if (!response.ok) throw new Error();
                const data = await response.json();
                if (data && data.html) return { success: true };
                return { success: false };
            } catch (error) {
                return { success: false };
            }
        }

        async function loadOEmbed() {
            if (!currentVideoUrl) return;
            const container = document.getElementById('oembedContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const response = await fetch(oembedUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data && data.html) {
                    container.innerHTML = data.html;
                    await loadEmbedScript();
                } else {
                    throw new Error('No HTML in response');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 1.8em; margin-bottom: 10px;">❌</div>
                        <div>oEmbed API không khả dụng</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Lỗi: ${error.message}</div>
                    </div>
                `;
            }
        }

        async function tryOEmbedProxy() {
            const container = document.getElementById('oembedContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(oembedUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data && data.html) {
                    container.innerHTML = data.html;
                    await loadEmbedScript();
                } else {
                    throw new Error('Không có HTML data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 1.8em; margin-bottom: 10px;">❌</div>
                        <div>CORS Proxy cũng thất bại</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Thử Blockquote method</div>
                    </div>
                `;
            }
        }

        async function loadBlockquote() {
            if (!currentVideoId || !currentVideoUrl) return;
            const container = document.getElementById('blockquoteContainer');
            
            const blockquoteHtml = `
                <blockquote class="tiktok-embed" 
                           cite="${currentVideoUrl}" 
                           data-video-id="${currentVideoId}" 
                           style="max-width: 100%; min-width: 280px; margin: 0 auto;">
                    <section>
                        <a target="_blank" href="${currentVideoUrl}">
                            Xem video TikTok này
                        </a>
                    </section>
                </blockquote>
            `;
            
            container.innerHTML = blockquoteHtml;
            await loadEmbedScript();
        }

        function forceReloadScript() {
            const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
            if (existingScript) {
                existingScript.remove();
            }
            embedScriptLoaded = false;
            loadBlockquote();
        }

        async function loadEmbedScript() {
            if (embedScriptLoaded) return;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://www.tiktok.com/embed.js';
                script.async = true;
                script.onload = () => {
                    embedScriptLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Script load failed'));
                };
                document.head.appendChild(script);
            });
        }

        function resetAllContainers() {
            document.getElementById('smartContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">🎯</div>
                    <div>Smart Auto sẽ tự động thử các phương pháp embed</div>
                    <div class="placeholder-note">Blockquote → oEmbed → External backup</div>
                </div>
            `;

            document.getElementById('oembedContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">🎬</div>
                    <div>TikTok oEmbed API</div>
                    <div class="placeholder-note">Phương thức chính thức từ TikTok</div>
                </div>
            `;

            document.getElementById('blockquoteContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">📺</div>
                    <div>TikTok Blockquote</div>
                    <div class="placeholder-note">Native embed method</div>
                </div>
            `;
        }

        // Navigation functions
        function previousVideo() {
            if (currentVideoIndex > 0) {
                loadVideo(currentVideoIndex - 1);
            }
        }

        function nextVideo() {
            if (currentVideoIndex < csvData.length - 1) {
                loadVideo(currentVideoIndex + 1);
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.querySelector('.nav-btn.prev');
            const nextBtn = document.querySelector('.nav-btn.next');
            
            prevBtn.disabled = currentVideoIndex <= 0;
            nextBtn.disabled = currentVideoIndex >= csvData.length - 1;
        }

        // Label management
        function setLabel(label) {
            if (currentVideoIndex >= 0 && currentVideoIndex < csvData.length) {
                const row = csvData[currentVideoIndex];
                // List of main labels (not confuse, not empty)
                const mainLabels = ['Harmful Content', 'Suicide', 'Adult Content', 'Safe'];
                if (label === 'confuse') {
                    // Toggle confuse
                    row['confuse'] = !row['confuse'];
                    // If confuse is now true, allow one main label (keep current selection)
                    // If confuse is now false, do nothing else
                } else if (label === 'Empty') {
                    // Only empty is selected
                    mainLabels.forEach(l => row[l] = false);
                    row['confuse'] = false;
                    row['Empty'] = true;
                } else {
                    // Select only this main label, keep confuse if it was selected
                    mainLabels.forEach(l => row[l] = false);
                    row[label] = true;
                    row['Empty'] = false;
                    // If confuse is selected, allow both
                }
                // Ensure only one main label is selected at a time
                let selectedMain = mainLabels.filter(l => row[l]);
                if (selectedMain.length > 1) {
                    // Only keep the last selected
                    mainLabels.forEach(l => row[l] = false);
                    row[label] = true;
                }
                // If empty is selected, all others must be false
                if (row['Empty']) {
                    mainLabels.forEach(l => row[l] = false);
                    row['confuse'] = false;
                }
                displayVideoList();
                updateStats();
                hasUnsavedChanges = true;
                autoSave();
                // Auto next if enabled and not confuse
                if (document.getElementById('autoNextToggle')?.checked && label !== 'confuse') {
                    setTimeout(() => nextVideo(), 250);
                }
                // Update label button UI
                updateLabelButtonUI(row);
            }
        }

        function updateLabelButtonUI(row) {
            const btns = document.querySelectorAll('.label-btn');
            btns.forEach(btn => {
                btn.classList.remove('active', 'selected');
            });
            if (!row) return;
            if (row['Harmful Content']) document.querySelector('.label-btn.harmful')?.classList.add('active');
            if (row['Suicide']) document.querySelector('.label-btn.suicide')?.classList.add('active');
            if (row['Adult Content']) document.querySelector('.label-btn.adult')?.classList.add('active');
            if (row['Safe']) document.querySelector('.label-btn.safe')?.classList.add('active');
            if (row['confuse']) document.querySelector('.label-btn.confuse')?.classList.add('active');
            if (row['Empty']) document.querySelector('.label-btn.empty')?.classList.add('active');
        }

        function updateStats() {
            const total = csvData.length;
            let labeled = 0;

            csvData.forEach(row => {
                const hasLabel = (
                    (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1') ||
                    (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1') ||
                    (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1') ||
                    (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1') ||
                    (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1') ||
                    (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1')
                );
                
                if (hasLabel) {
                    labeled++;
                }
            });

            const progress = total > 0 ? Math.round((labeled / total) * 100) : 0;

            document.getElementById('totalVideos').textContent = total;
            document.getElementById('labeledVideos').textContent = labeled;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Update file mode indicator
            const fileModeCard = document.getElementById('fileModeCard');
            const fileMode = document.getElementById('fileMode');
            const fileModeText = document.getElementById('fileModeText');
            
            if (csvData.length > 0) {
                fileModeCard.style.display = 'block';
                if (isSampleFile) {
                    fileMode.textContent = '🧪';
                    fileModeText.textContent = 'Test Mode';
                    fileModeCard.style.background = 'linear-gradient(45deg, #ffc107, #ff9800)';
                } else {
                    fileMode.textContent = '📁';
                    fileModeText.textContent = 'Real File';
                    fileModeCard.style.background = 'linear-gradient(45deg, #4CAF50, #45a049)';
                }
            } else {
                fileModeCard.style.display = 'none';
            }
        }

        // Add buffer management functions
        function addToSaveBuffer(change) {
            if (!change || !change.index) return;
            
            // Remove any existing change for the same video
            saveBuffer = saveBuffer.filter(item => item.index !== change.index);
            
            // Add new change
            saveBuffer.push({
                index: change.index,
                data: change.data,
                timestamp: Date.now()
            });

            // Schedule save
            scheduleSave();
        }

        function scheduleSave() {
            // Clear existing timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }

            // If buffer is full, save immediately
            if (saveBuffer.length >= MAX_BUFFER_SIZE) {
                performSave();
                return;
            }

            // Schedule new save
            saveTimeout = setTimeout(() => {
                if (saveBuffer.length > 0) {
                    performSave();
                }
            }, SAVE_DELAY);
        }

        async function performSave() {
            if (saveBuffer.length === 0 || !hasUnsavedChanges) return;
            if (lastSaveOperation && !lastSaveOperation.isDone) return;

            lastSaveOperation = { isDone: false };
            const currentOperation = lastSaveOperation;

            try {
                // Apply buffered changes
                saveBuffer.forEach(change => {
                    if (change.index >= 0 && change.index < csvData.length) {
                        csvData[change.index] = { ...csvData[change.index], ...change.data };
                    }
                });

                // Validate data integrity
                if (csvData.length < window._originalCsvLineCount) {
                    showNotification('⚠️ Phát hiện dữ liệu không hợp lệ, đang khôi phục...', 'error');
                    if (originalCsvContent) {
                        parseCSV(originalCsvContent);
                        showNotification('✅ Đã khôi phục dữ liệu!', 'success');
                    }
                    return;
                }

                const csvContent = generateCSVContent();
                
                // Handle sample file differently - only save temporarily
                if (isSampleFile) {
                    // For sample files, just show notification without saving
                    lastSaveTime = new Date();
                    hasUnsavedChanges = false;
                    showNotification('💾 Đã lưu tạm thời ' + saveBuffer.length + ' thay đổi! (Chế độ test)', 'success');
                } else if (fileHandle) {
                    try {
                        // Create write batch
                        const writable = await fileHandle.createWritable({
                            keepExistingData: false
                        });
                        const CHUNK_SIZE = 1024 * 1024;
                        for (let i = 0; i < csvContent.length; i += CHUNK_SIZE) {
                            const chunk = csvContent.slice(i, i + CHUNK_SIZE);
                            await writable.write(chunk);
                        }
                        await writable.close();
                        lastSaveTime = new Date();
                        hasUnsavedChanges = false;
                        showNotification('💾 Đã lưu ' + saveBuffer.length + ' thay đổi!', 'success');
                    } catch (error) {
                        console.warn('Lỗi khi lưu file:', error);
                        if (originalCsvContent) {
                            parseCSV(originalCsvContent);
                        }
                        fileHandle = null;
                        downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                        showNotification('❌ Lỗi khi lưu file, đã tải file tạm thời!', 'error');
                    }
                } else if (permissionRequested) {
                    downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                    showNotification('💾 Đã lưu file tạm thời!', 'success');
                }

                // Clear buffer after successful save
                saveBuffer = [];
            } catch (error) {
                showNotification('❌ Lỗi khi lưu: ' + error.message, 'error');
                if (originalCsvContent) {
                    parseCSV(originalCsvContent);
                }
            } finally {
                if (currentOperation === lastSaveOperation) {
                    lastSaveOperation.isDone = true;
                }
            }
        }

        // Helper function to generate CSV content
        function generateCSVContent() {
            // Ensure all columns are present in the correct order
            const allColumns = ['username', 'id_video', 'Safe', 'Suicide', 'Adult Content', 'Harmful Content', 'confuse', 'Empty'];
            let csvContent = allColumns.join(',') + '\n';

            csvData.forEach(row => {
                const values = allColumns.map(header => {
                    let value = row[header] || 'false';
                    if (header === 'id_video' && value) {
                        value = String(value);
                    }
                    if (typeof value === 'boolean') {
                        value = value ? 'true' : 'false';
                    }
                    return `"${value}"`;
                });
                csvContent += values.join(',') + '\n';
            });

            return csvContent;
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                lastSaveTime = new Date();
                hasUnsavedChanges = false;
                showNotification('💾 Đã lưu file tạm thời!', 'success');
            } catch (error) {
                showNotification('❌ Lỗi khi tải xuống file: ' + error.message, 'error');
            }
        }

        // Modify exportCSV function
        async function exportCSV() {
            if (csvData.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }

            // Validate data integrity
            if (csvData.length < window._originalCsvLineCount) {
                if (originalCsvContent) {
                    parseCSV(originalCsvContent);
                    showNotification('✅ Đã khôi phục dữ liệu ban đầu trước khi xuất!', 'success');
                } else {
                    alert('❌ Phát hiện mất dữ liệu! Không thể xuất file.');
                return;
            }
            }

            try {
                const csvContent = generateCSVContent();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const defaultFilename = isSampleFile ? 
                    `sample_test_results_${timestamp}.csv` : 
                    `labeled_tiktok_videos_${timestamp}.csv`;

                // For sample files, always download without permission dialog
                if (isSampleFile) {
                    downloadCSV(csvContent, defaultFilename);
                    showNotification('💾 Đã xuất kết quả test!', 'success');
                    return;
                }

                if (!permissionRequested) {
                    const granted = await showPermissionDialog();
                    permissionRequested = true;

                    if (granted) {
                        try {
                            const newFileHandle = await window.showSaveFilePicker({
                                suggestedName: defaultFilename,
                                types: [{
                                    description: 'CSV Files',
                                    accept: {'text/csv': ['.csv']},
                                }],
                            });

                            const writable = await newFileHandle.createWritable();
                            await writable.write(csvContent);
                            await writable.close();
                            showNotification('💾 Đã xuất CSV thành công!', 'success');
                            return;
                        } catch (error) {
                            console.warn('Không thể lưu file:', error);
                        }
                    }
                }

                // Fallback to download
                downloadCSV(csvContent, defaultFilename);
            } catch (error) {
                showNotification('❌ Lỗi khi xuất CSV: ' + error.message, 'error');
                if (originalCsvContent) {
                    parseCSV(originalCsvContent);
                    showNotification('✅ Đã khôi phục dữ liệu ban đầu sau lỗi!', 'success');
                }
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (csvData.length === 0) return;

            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousVideo();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextVideo();
                    break;
                case '1':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('Harmful Content'); }
                    break;
                case '2':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('Suicide'); }
                    break;
                case '3':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('Adult Content'); }
                    break;
                case '4':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('Safe'); }
                    break;
                case '5':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('confuse'); }
                    break;
                case '6':
                    if (e.ctrlKey) { e.preventDefault(); setLabel('Empty'); }
                    break;
                case 's':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        exportCSV();
                    }
                    break;
            }
        });

        async function loadGuideline() {
            try {
                const response = await fetch('Guideline.csv');
                const text = await response.text();
                const data = Papa.parse(text, {header: true, skipEmptyLines: true}).data;
                
                let notes = [];
                let html = '';
                const colors = ['#ffe7ba', '#ffd6e7', '#d6f5ff', '#e2ffe6'];
                const icons = ['🔞','⚠️','🆘','✅'];
                
                data.forEach((row, idx) => {
                    if (!row.Label) {
                        if (row.Defination) notes.push(row.Defination);
                        return;
                    }
                    
                    let videoHtml = '';
                    if (row.Link && row.Link.length > 5) {
                        let parts = row.Link.split('_');
                        if (parts.length === 2) {
                            let username = parts[0];
                            let vid = parts[1];
                            let tiktokUrl = `https://www.tiktok.com/@${username}/video/${vid}`;
                            videoHtml = `
                                <div style='margin-top:8px;'>
                                    <blockquote class="tiktok-embed" cite="${tiktokUrl}" data-video-id="${vid}" style="max-width: 280px; min-width: 200px; margin: 0 auto;">
                                        <section>
                                            <a target="_blank" href="${tiktokUrl}">Xem video ví dụ</a>
                                        </section>
                                    </blockquote>
                                </div>
                            `;
                        }
                    }
                    
                    const def = (row.Defination||'').replace(/\\n|\n/g, '<br>');
                    const ex = (row.Example||'').replace(/\\n|\n/g, '<br>');
                    html += `<div class="guideline-card" style="background:${colors[idx%colors.length]}">
                        <div class='label-title'>${icons[idx%icons.length]} ${row.Label}</div>
                        <div class='label-def'><b>Định nghĩa:</b> <span>${def}</span></div>
                        <div class='label-example'><b>Ví dụ:</b><br><span>${ex}</span>${videoHtml}</div>
                    </div>`;
                });
                
                document.getElementById('guidelineCards').innerHTML = html;
                document.getElementById('guidelineNote').innerHTML = notes.map(n => `<div style='margin-bottom:3px;font-size:0.9em;'>${n}</div>`).join('');
                
                if (document.querySelector('.tiktok-embed')) {
                    const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
                    if (existingScript) existingScript.remove();
                    const script = document.createElement('script');
                    script.src = 'https://www.tiktok.com/embed.js';
                    script.async = true;
                    document.head.appendChild(script);
                }
            } catch (e) {
                document.getElementById('guidelineCards').innerHTML = '<i>Không thể tải guideline.</i>';
            }
        }

        // Load sample file function
        async function loadSampleFile() {
            try {
                showNotification('🔄 Đang tải file mẫu...', 'success');
                
                const response = await fetch('100samples.csv');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvContent = await response.text();
                if (!csvContent || csvContent.trim().length === 0) {
                    throw new Error('File mẫu trống hoặc không hợp lệ');
                }

                // Reset previous data
                csvData = [];
                fileHandle = null;
                originalFile = null;
                hasUnsavedChanges = false;
                permissionRequested = false;
                isSampleFile = true; // Mark as sample file

                // Store original content
                originalCsvContent = csvContent;
                
                // Parse CSV data
                parseCSV(csvContent);
                initialDataLoaded = true;

                showNotification('✅ Đã tải file mẫu thành công! Bạn có thể bắt đầu gắn nhãn. (Chế độ test - chỉ lưu tạm thời)', 'success');
                
                // Auto load first video
                if (csvData.length > 0) {
                    setTimeout(() => {
                        autoLoadFirstVideo();
                    }, 500);
                }
                
            } catch (error) {
                console.error('Lỗi khi tải file mẫu:', error);
                showNotification('❌ Không thể tải file mẫu: ' + error.message, 'error');
                
                // Fallback: try to create a sample file
                try {
                    const sampleData = `username,id_video,Safe,Suicide,Adult Content,Harmful Content,confuse,Empty
"sample_user1","7116841099070623003","false","false","false","false","false","false"
"sample_user2","7298717939052711170","false","false","false","false","false","false"
"sample_user3","7361815198019226897","false","false","false","false","false","false"`;
                    
                    originalCsvContent = sampleData;
                    parseCSV(sampleData);
                    initialDataLoaded = true;
                    isSampleFile = true; // Mark as sample file
                    
                    showNotification('✅ Đã tạo dữ liệu mẫu để test! (Chế độ test - chỉ lưu tạm thời)', 'success');
                    
                    if (csvData.length > 0) {
                        setTimeout(() => {
                            autoLoadFirstVideo();
                        }, 500);
                    }
                } catch (fallbackError) {
                    showNotification('❌ Không thể tạo dữ liệu mẫu: ' + fallbackError.message, 'error');
                }
            }
        }

        // Initialize on load
        console.log('TikTok Video Labeling Tool v2.3 loaded successfully!');
        loadGuideline();

        // Accordion/collapsible logic
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.getElementById('accordionHeader');
            const content = document.getElementById('accordionContent');
            if (header && content) {
                header.addEventListener('click', function() {
                    header.classList.toggle('collapsed');
                    content.classList.toggle('collapsed');
                });
            }
        });

        // Add auto-save interval
        setInterval(() => {
            if (saveBuffer.length > 0) {
                performSave();
            } else if (hasUnsavedChanges && lastSaveTime) {
                const now = new Date();
                if (now - lastSaveTime >= AUTO_SAVE_INTERVAL) {
                    performSave();
                }
            }
        }, 60000); // Check every minute

        // Add beforeunload event listener
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Cảnh báo CORS TikTok embed (chỉ cho dev)
        (function() {
            const origConsoleError = console.error;
            console.error = function(...args) {
                if (args && args.length > 0 && typeof args[0] === 'string' && args[0].includes('Access to XMLHttpRequest at') && args[0].includes('mon.tiktokv.com/monitor_browser/collect/batch')) {
                    const corsWarn = document.getElementById('corsWarning');
                    if (corsWarn) corsWarn.style.display = 'block';
                }
                origConsoleError.apply(console, args);
            };
        })();

        // Add window unload handler to save pending changes
        window.addEventListener('beforeunload', async (e) => {
            if (saveBuffer.length > 0) {
                e.preventDefault();
                e.returnValue = '';
                
                // Try to save remaining changes
                await performSave();
                
                return '';
            }
        });

        // Restore autoSave to always show notification after save
        async function autoSave() {
            if (csvData.length === 0 || !hasUnsavedChanges) return;
            if (csvData.length < window._originalCsvLineCount) {
                showNotification('⚠️ Phát hiện số dòng dữ liệu ít hơn ban đầu! Đang khôi phục...', 'error');
                if (originalCsvContent) {
                    parseCSV(originalCsvContent);
                    showNotification('✅ Đã khôi phục dữ liệu ban đầu!', 'success');
                }
                return;
            }
            try {
                const csvContent = generateCSVContent();
                
                // Handle sample file differently
                if (isSampleFile) {
                    lastSaveTime = new Date();
                    hasUnsavedChanges = false;
                    showNotification('💾 Đã lưu tạm thời! (Chế độ test)', 'success');
                } else if (fileHandle) {
                    try {
                        const writable = await fileHandle.createWritable();
                        await writable.write(csvContent);
                        await writable.close();
                        lastSaveTime = new Date();
                        hasUnsavedChanges = false;
                        showNotification('💾 Đã lưu thay đổi!', 'success');
                    } catch (error) {
                        console.warn('Lỗi khi lưu file:', error);
                        if (originalCsvContent) {
                            parseCSV(originalCsvContent);
                        }
                        fileHandle = null;
                        downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                        showNotification('❌ Lỗi khi lưu file, đã tải file tạm thời!', 'error');
                    }
                } else if (permissionRequested) {
                    downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                    showNotification('💾 Đã lưu file tạm thời!', 'success');
                }
            } catch (error) {
                showNotification('❌ Lỗi khi tự động lưu: ' + error.message, 'error');
                if (originalCsvContent) {
                    parseCSV(originalCsvContent);
                }
            }
        }

        // Add dark mode logic
        (function() {
            const root = document.documentElement;
            const themeBtn = document.getElementById('themeToggleBtn');
            function setTheme(mode) {
                if (mode === 'dark') {
                    root.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                    if (themeBtn) themeBtn.textContent = '☀️';
                } else {
                    root.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                    if (themeBtn) themeBtn.textContent = '🌙';
                }
            }
            // Init
            const saved = localStorage.getItem('theme');
            setTheme(saved === 'dark' ? 'dark' : 'light');
            if (themeBtn) themeBtn.onclick = function() {
                setTheme(root.classList.contains('dark-mode') ? 'light' : 'dark');
            };
        })();
    </script>
</body>
</html>