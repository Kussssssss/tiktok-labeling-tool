<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok Video Labeling Tool v2.1</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            color: #4a5568;
            margin-bottom: 12px;
            font-size: 2.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .version-badge {
            background: linear-gradient(45deg, #ff0050, #ff4081);
            color: white;
            padding: 6px 14px;
            border-radius: 18px;
            font-size: 0.85em;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 0, 80, 0.3);
        }

        /* Upload Section */
        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.3s ease;
            margin-right: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .file-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Stats Section */
        .stats {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 18px 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1;
            min-width: 140px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .stat-card div:first-child {
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        /* IMPROVED MAIN CONTENT LAYOUT */
        .main-content {
            display: grid;
            grid-template-columns: 380px 1fr 320px;
            grid-template-areas: "video-list player-section controls";
            gap: 20px;
            align-items: start;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 800px;
        }

        /* Video List - Left Column */
        .video-list {
            grid-area: video-list;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            padding: 20px;
            height: 800px;
            display: flex;
            flex-direction: column;
        }

        .video-list h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f8f9fa;
        }

        .video-list-container {
            flex: 1;
            overflow-y: auto;
            margin: 0 -8px 0 0;
            padding-right: 8px;
        }

        .video-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .video-item:hover {
            background: #e9ecef;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .video-item.active {
            background: #e3f2fd;
            border-left-color: #2196F3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
        }

        .video-info {
            flex: 1;
            min-width: 0;
        }

        .video-filename {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .label-tag {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .label-tag.active {
            background: #dc3545;
        }

        .label-tag.safe {
            background: #28a745;
        }

        /* Player Section - Center Column */
        .player-section {
            grid-area: player-section;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.10);
            border: 1px solid #eee;
            padding: 25px;
            height: 800px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .current-video-info {
            text-align: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            font-size: 0.95em;
        }

        .navigation-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9em;
        }

        .nav-btn.prev {
            background: #6c757d;
            color: white;
        }

        .nav-btn.next {
            background: #28a745;
            color: white;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-btn:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Video Player Container */
        .video-player-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 12px;
            min-height: 500px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        /* Accordion for methods */
        .accordion {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            background: #f8f9fa;
        }

        .accordion-header {
            background: #764ba2;
            color: #fff;
            padding: 14px 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-header .arrow {
            transition: transform 0.2s;
            font-size: 1.1em;
        }

        .accordion-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .accordion-content {
            padding: 16px 20px;
            display: block;
            animation: fadeIn 0.3s;
            max-height: 200px;
            overflow-y: auto;
        }

        .accordion-content.collapsed {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Controls Panel - Right Column */
        .controls-panel {
            grid-area: controls;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 800px;
        }

        .labeling-controls {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .labeling-controls h3 {
            color: #2c3e50;
            margin-bottom: 16px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f8f9fa;
        }

        .label-groups {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .label-group {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .label-group:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .label-group h4 {
            margin-bottom: 12px;
            color: #495057;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .checkbox-wrapper:hover {
            background: rgba(0, 0, 0, 0.04);
        }

        .checkbox-wrapper input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            cursor: pointer;
        }

        .checkbox-wrapper label {
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Export Section */
        .export-section {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #eee;
            padding: 20px;
        }

        .export-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 12px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        /* Tab Styles */
        .video-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 8px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.8em;
        }

        .tab-btn.active, .tab-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Embed Options */
        .embed-options {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .embed-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .embed-btn.primary {
            background: #ff0050;
            color: white;
            font-weight: 600;
            padding: 10px 16px;
            box-shadow: 0 3px 12px rgba(255, 0, 80, 0.3);
        }

        .embed-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .embed-btn.primary:hover {
            background: #e6004a;
            transform: translateY(-1px);
            box-shadow: 0 6px 18px rgba(255, 0, 80, 0.4);
        }

        /* Embed Container */
        .embed-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .embed-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            max-width: 300px;
        }

        .placeholder-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
            opacity: 0.9;
        }

        .placeholder-note {
            font-size: 0.8em;
            margin-top: 8px;
            opacity: 0.7;
            line-height: 1.4;
        }

        /* TikTok Embed */
        .tiktok-embed {
            max-width: 100% !important;
            min-width: 280px !important;
            margin: 0 auto;
        }

        /* Loading Spinner */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Guideline Section */
        .guideline-section {
            background: #fffbe6;
            border: 1px solid #ffe58f;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .guideline-section h3 {
            color: #d48806;
            margin-bottom: 16px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Error and Success Containers */
        .error-container {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
            margin: 15px 0;
            font-size: 0.9em;
        }

        .success-container {
            text-align: center;
            padding: 20px;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin: 15px 0;
            font-size: 0.9em;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            font-weight: 600;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .notification.success {
            background: #28a745;
            color: white;
        }

        .notification.error {
            background: #dc3545;
            color: white;
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-areas: 
                    "player-section"
                    "controls"
                    "video-list";
                gap: 16px;
            }
            
            .video-list,
            .player-section,
            .controls-panel {
                height: auto;
                min-height: unset;
            }
            
            .video-list {
                max-height: 400px;
            }
            
            .player-section {
                min-height: 700px;
            }
            
            .controls-panel {
                flex-direction: row;
                gap: 16px;
            }
            
            .labeling-controls,
            .export-section {
                flex: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 12px;
            }

            .header {
                padding: 18px;
            }

            .header h1 {
                font-size: 1.8em;
                flex-direction: column;
                gap: 8px;
            }

            .stats {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }
            
            .controls-panel {
                flex-direction: column;
            }
            
            .main-content {
                gap: 12px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 6px;
            }
        }

        @media (max-width: 480px) {
            .video-tabs {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1 1 45%;
                font-size: 0.75em;
                padding: 6px 8px;
            }
            
            .embed-options {
                flex-direction: column;
            }
            
            .embed-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎥 TikTok Video Labeling Tool <span class="version-badge">v2.1</span></h1>
            <p>Công cụ gắn nhãn video TikTok chuyên nghiệp với giao diện được tối ưu</p>
        </div>

        <!-- Guideline Section -->
        <div class="upload-section guideline-section" id="guidelineSection">
            <h3>📚 Hướng dẫn gắn nhãn (Guideline)</h3>
            <div id="guidelineCards" style="display: flex; flex-wrap: wrap; gap: 16px;"></div>
            <div id="guidelineNote" style="margin-top: 16px; color: #d48806; font-size: 0.95em;"></div>
        </div>

        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" />
                📁 Chọn file CSV
            </div>
            <button onclick="exportCSV()" class="export-btn" style="display:none; width: auto; padding: 8px 16px; margin-left: 12px; font-size: 0.9em;" id="exportBtn">
                💾 Xuất CSV
            </button>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div id="totalVideos">0</div>
                    <div>Tổng video</div>
                </div>
                <div class="stat-card">
                    <div id="labeledVideos">0</div>
                    <div>Đã gắn nhãn</div>
                </div>
                <div class="stat-card">
                    <div id="progressPercent">0%</div>
                    <div>Tiến độ</div>
                </div>
            </div>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="main-content" id="mainContent" style="display: none;">
            <!-- Video List - Left Column -->
            <div class="video-list">
                <h3>📋 Danh sách video</h3>
                <div class="video-list-container" id="videoListContainer"></div>
            </div>

            <!-- Player Section - Center Column -->
            <div class="player-section">
                <div class="current-video-info" id="currentVideoInfo">
                    Chọn một video để bắt đầu
                </div>

                <div class="navigation-buttons">
                    <button class="nav-btn prev" onclick="previousVideo()">⬅️ Trước</button>
                    <button class="nav-btn next" onclick="nextVideo()">Tiếp ➡️</button>
                </div>
                
                <!-- Video player container -->
                <div id="videoPlayerContainer" class="video-player-container" style="display: none;">
                    <!-- TikTok embed sẽ được render ở đây -->
                </div>

                <!-- Accordion for embed methods -->
                <div class="accordion" id="embedAccordion">
                    <div class="accordion-header" id="accordionHeader">
                        <span>🔧 Các phương pháp nhúng video</span>
                        <span class="arrow">▼</span>
                    </div>
                    <div class="accordion-content" id="accordionContent">
                        <div class="video-tabs">
                            <button class="tab-btn active" onclick="switchTab('smart', event)">🎯 Smart</button>
                            <button class="tab-btn" onclick="switchTab('oembed', event)">🎬 oEmbed</button>
                            <button class="tab-btn" onclick="switchTab('blockquote', event)">📺 Block</button>
                            <button class="tab-btn" onclick="switchTab('external', event)">🔗 Link</button>
                        </div>

                        <!-- Smart Auto Tab -->
                        <div id="smartTab" class="tab-content active">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="smartLoadVideo()">
                                    🚀 Tự động tìm cách tốt nhất
                                </button>
                            </div>
                            <div id="smartContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">🎯</div>
                                    <div>Smart Auto sẽ tự động thử các phương pháp embed</div>
                                    <div class="placeholder-note">Blockquote → oEmbed → External backup</div>
                                </div>
                            </div>
                        </div>

                        <!-- oEmbed Tab -->
                        <div id="oembedTab" class="tab-content">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="loadOEmbed()">🚀 Tải qua oEmbed</button>
                                <button class="embed-btn" onclick="tryOEmbedProxy()">🔄 Thử Proxy</button>
                            </div>
                            <div id="oembedContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">🎬</div>
                                    <div>TikTok oEmbed API</div>
                                    <div class="placeholder-note">Phương thức chính thức từ TikTok</div>
                                </div>
                            </div>
                        </div>

                        <!-- Blockquote Tab -->
                        <div id="blockquoteTab" class="tab-content">
                            <div class="embed-options">
                                <button class="embed-btn primary" onclick="loadBlockquote()">📺 Embed</button>
                                <button class="embed-btn" onclick="forceReloadScript()">🔄 Reload</button>
                            </div>
                            <div id="blockquoteContainer" class="embed-container">
                                <div class="embed-placeholder">
                                    <div class="placeholder-icon">📺</div>
                                    <div>TikTok Blockquote</div>
                                    <div class="placeholder-note">Native embed method</div>
                                </div>
                            </div>
                        </div>

                        <!-- External Tab -->
                        <div id="externalTab" class="tab-content">
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <button id="openTikTokBtn" style="flex: 1; background: #ff0050; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em;">
                                    📱 Xem Video
                                </button>
                                <button id="copyUrlBtn" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                                    📋
                                </button>
                            </div>
                            
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="font-size: 0.8em; margin-bottom: 6px; opacity: 0.9;">🔗 URL Public:</div>
                                <div id="videoUrl" style="font-family: monospace; font-size: 0.75em; word-break: break-all; background: rgba(0,0,0,0.2); padding: 6px; border-radius: 4px;">
                                    https://www.tiktok.com/@tiktok/video/7196733917032877354
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel - Right Column -->
            <div class="controls-panel">
                <div class="labeling-controls">
                    <h3>🏷️ Gắn nhãn</h3>
                    <div class="label-groups" id="labelingControls" style="display: none;">
                        <div class="label-group">
                            <h4>🚫 Nội dung có hại</h4>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="harmfulContent" onchange="updateLabels()">
                                <label for="harmfulContent">Harmful Content</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="suicide" onchange="updateLabels()">
                                <label for="suicide">Suicide</label>
                            </div>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="adultContent" onchange="updateLabels()">
                                <label for="adultContent">Adult Content</label>
                            </div>
                        </div>
                        
                        <div class="label-group">
                            <h4>✅ An toàn</h4>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="safe" onchange="updateLabels()">
                                <label for="safe">Safe</label>
                            </div>
                        </div>

                        <div class="label-group">
                            <h4>🤔 Phân vân</h4>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="confuse" onchange="updateLabels()">
                                <label for="confuse">Confuse</label>
                            </div>
                        </div>

                        <div class="label-group">
                            <h4>❌ Không khả dụng</h4>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="empty" onchange="updateLabels()">
                                <label for="empty">Empty (Video đã bị xóa/không khả dụng)</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="export-section">
                    <button class="export-btn" onclick="exportCSV()">
                        💾 Xuất kết quả CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let csvData = [];
        let currentVideoIndex = 0;
        let currentVideoId = null;
        let currentVideoUrl = null;
        let currentPlayerUrl = null;
        let embedScriptLoaded = false;
        let fileHandle = null;
        let lastSaveTime = null;
        let originalFile = null;
        let hasUnsavedChanges = false;
        let permissionRequested = false;

        // Reset file input value when clicking
        document.getElementById('csvFile').addEventListener('click', function(e) {
            this.value = ''; // Reset file input
        });

        // Add permission request dialog
        function showPermissionDialog() {
            return new Promise((resolve) => {
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 1000;
                    max-width: 400px;
                    width: 90%;
                `;
                
                dialog.innerHTML = `
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">Yêu cầu quyền truy cập file</h3>
                    <p style="margin-bottom: 20px; color: #4a5568; line-height: 1.5;">
                        Để tự động lưu các thay đổi, chúng tôi cần quyền truy cập vào file của bạn.
                        Nếu bạn từ chối, các thay đổi sẽ được lưu tạm thời và bạn cần xuất file thủ công.
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button id="denyPermission" style="
                            padding: 8px 16px;
                            border: 1px solid #e2e8f0;
                            border-radius: 6px;
                            background: #f8fafc;
                            color: #4a5568;
                            cursor: pointer;
                        ">Từ chối</button>
                        <button id="grantPermission" style="
                            padding: 8px 16px;
                            border: none;
                            border-radius: 6px;
                            background: #4299e1;
                            color: white;
                            cursor: pointer;
                        ">Đồng ý</button>
                    </div>
                `;

                // Add overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 999;
                `;

                document.body.appendChild(overlay);
                document.body.appendChild(dialog);

                // Handle button clicks
                document.getElementById('grantPermission').onclick = () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                    resolve(true);
                };

                document.getElementById('denyPermission').onclick = () => {
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                    resolve(false);
                };
            });
        }

        // File input event listener
        document.getElementById('csvFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                // Reset previous data
                csvData = [];
                fileHandle = null;
                originalFile = file;
                hasUnsavedChanges = false;
                permissionRequested = false;

                // Read file content
                const csv = await readFileContent(file);
                if (!csv) {
                    throw new Error('Không thể đọc nội dung file');
                }

                // Parse CSV data
                parseCSV(csv);

                // Request permission if not already requested
                if (!permissionRequested) {
                    const granted = await showPermissionDialog();
                    permissionRequested = true;

                    if (granted) {
                        try {
                            fileHandle = await window.showSaveFilePicker({
                                suggestedName: file.name,
                                types: [{
                                    description: 'CSV Files',
                                    accept: {'text/csv': ['.csv']},
                                }],
                            });
                            showNotification('📂 Đã tải file CSV thành công!', 'success');
                        } catch (error) {
                            console.warn('Không thể lấy quyền truy cập file:', error);
                            showNotification('⚠️ Không thể lấy quyền truy cập file. Dữ liệu sẽ được lưu tạm thời.', 'error');
                        }
                    } else {
                        showNotification('ℹ️ Bạn có thể xuất file thủ công khi cần.', 'success');
                    }
                }
            } catch (error) {
                showNotification('❌ Lỗi khi xử lý file: ' + error.message, 'error');
                resetUI();
            }
        });

        // Helper function to reset UI
        function resetUI() {
            document.getElementById('stats').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('exportBtn').style.display = 'none';
            document.getElementById('videoListContainer').innerHTML = '';
            document.getElementById('currentVideoInfo').innerHTML = 'Chọn một video để bắt đầu';
            document.getElementById('videoPlayerContainer').style.display = 'none';
            document.getElementById('labelingControls').style.display = 'none';
        }

        // Helper function to read file content
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Lỗi khi đọc file'));
                reader.readAsText(file);
            });
        }

        // Parse CSV data
        function parseCSV(csv) {
            try {
                const lines = csv.split('\n');
                if (lines.length < 2) {
                    throw new Error('File CSV không có dữ liệu');
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                csvData = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                        if (values.length !== headers.length) {
                            console.warn(`Dòng ${i + 1} có số cột không khớp với header`);
                            continue;
                        }
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        csvData.push(row);
                    }
                }

                if (csvData.length === 0) {
                    throw new Error('Không có dữ liệu hợp lệ trong file CSV');
                }

                displayVideoList();
                updateStats();
                document.getElementById('stats').style.display = 'flex';
                document.getElementById('progressBar').style.display = 'block';
                document.getElementById('mainContent').style.display = 'grid';
                document.getElementById('exportBtn').style.display = 'inline-block';
                
                if (csvData.length > 0) {
                    autoLoadFirstVideo();
                }
            } catch (error) {
                showNotification('❌ Lỗi khi xử lý CSV: ' + error.message, 'error');
            }
        }

        function autoLoadFirstVideo() {
            try {
                loadVideo(0);
                setTimeout(() => {
                    switchTab('smart', null);
                    smartLoadVideo();
                }, 200);
            } catch (error) {
                showNotification('❌ Lỗi khi tải video đầu tiên: ' + error.message, 'error');
            }
        }

        function displayVideoList() {
            try {
                const container = document.getElementById('videoListContainer');
                container.innerHTML = '';
                
                csvData.forEach((row, index) => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'video-item';
                    videoItem.onclick = () => loadVideo(index);
                    
                    const labels = [];
                    if (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1') {
                        labels.push('<span class="label-tag active">Harmful</span>');
                    }
                    if (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1') {
                        labels.push('<span class="label-tag active">Suicide</span>');
                    }
                    if (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1') {
                        labels.push('<span class="label-tag active">Adult</span>');
                    }
                    if (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1') {
                        labels.push('<span class="label-tag safe">Safe</span>');
                    }
                    if (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1') {
                        labels.push('<span class="label-tag">Confuse</span>');
                    }
                    if (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1') {
                        labels.push('<span class="label-tag" style="background: #dc3545;">Empty</span>');
                    }
                    if (labels.length === 0) {
                        labels.push('<span class="label-tag" style="background: #6c757d; opacity: 0.7;">Chưa gắn nhãn</span>');
                    }

                    videoItem.innerHTML = `
                        <div class="video-info">
                            <div class="video-filename">${row.username || ''} <span style='color:#888; font-size: 0.85em;'>(${row.id_video})</span></div>
                            <div class="video-labels">${labels.join('')}</div>
                        </div>
                        <div style="color: #6c757d; font-size: 0.85em; min-width: 30px; text-align: right;">#${index + 1}</div>
                    `;
                    container.appendChild(videoItem);
                });
            } catch (error) {
                showNotification('❌ Lỗi khi hiển thị danh sách video: ' + error.message, 'error');
            }
        }

        // Load a specific video by index
        function loadVideo(index) {
            try {
                if (index < 0 || index >= csvData.length) {
                    throw new Error('Index video không hợp lệ');
                }

                currentVideoIndex = index;
                const row = csvData[index];
                const videoId = row.id_video;
                
                if (!videoId) {
                    throw new Error('Không tìm thấy ID video');
                }

                currentVideoId = videoId;
                
                // Update active state in video list
                document.querySelectorAll('.video-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });

                // Update video info display
                document.getElementById('currentVideoInfo').innerHTML = `
                    <strong>Video ${index + 1} / ${csvData.length}</strong><br>
                    <small>${row.username || ''} (${row.id_video})</small>
                `;

                // Setup video URLs
                const publicUrl = `https://www.tiktok.com/@tiktok/video/${videoId}`;
                const playerUrl = `https://www.tiktok.com/player/v1/${videoId}?autoplay=1&controls=1`;
                
                currentVideoUrl = publicUrl;
                currentPlayerUrl = playerUrl;
                
                const urlDisplay = document.getElementById('videoUrl');
                if (urlDisplay) urlDisplay.textContent = publicUrl;

                // Setup button handlers
                const openBtn = document.getElementById('openTikTokBtn');
                const copyBtn = document.getElementById('copyUrlBtn');

                if (openBtn) {
                    openBtn.onclick = () => {
                        window.open(publicUrl, '_blank');
                        openBtn.textContent = '✅ Đã mở!';
                        setTimeout(() => {
                            openBtn.textContent = '📱 Xem Video';
                        }, 2000);
                    };
                }

                if (copyBtn) {
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(publicUrl).then(() => {
                            copyBtn.textContent = '✅';
                            setTimeout(() => {
                                copyBtn.textContent = '📋';
                            }, 1500);
                        }).catch(() => {
                            const textArea = document.createElement('textarea');
                            textArea.value = publicUrl;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            copyBtn.textContent = '✅';
                            setTimeout(() => {
                                copyBtn.textContent = '📋';
                            }, 1500);
                        });
                    };
                }

                // Reset containers and show player
                resetAllContainers();
                const playerContainer = document.getElementById('videoPlayerContainer');
                playerContainer.style.display = 'flex';

                // Render TikTok blockquote in player container
                playerContainer.innerHTML = `
                    <blockquote class="tiktok-embed" cite="${publicUrl}" data-video-id="${videoId}" style="max-width: 100%; min-width: 300px; margin: 0 auto;">
                        <section>
                            <a target="_blank" href="${publicUrl}">Xem video TikTok này</a>
                        </section>
                    </blockquote>
                `;

                // Load TikTok embed script
                setTimeout(() => {
                    const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
                    if (existingScript) existingScript.remove();
                    const script = document.createElement('script');
                    script.src = 'https://www.tiktok.com/embed.js';
                    script.async = true;
                    document.head.appendChild(script);
                }, 100);

                // Load current labels
                const harmfulCheckbox = document.getElementById('harmfulContent');
                const suicideCheckbox = document.getElementById('suicide');
                const adultCheckbox = document.getElementById('adultContent');
                const safeCheckbox = document.getElementById('safe');
                const confuseCheckbox = document.getElementById('confuse');
                const emptyCheckbox = document.getElementById('empty');

                harmfulCheckbox.checked = (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1');
                suicideCheckbox.checked = (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1');
                adultCheckbox.checked = (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1');
                safeCheckbox.checked = (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1');
                confuseCheckbox.checked = (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1');
                emptyCheckbox.checked = (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1');

                document.getElementById('labelingControls').style.display = 'flex';
                updateNavigationButtons();
            } catch (error) {
                showNotification('❌ Lỗi khi tải video: ' + error.message, 'error');
            }
        }

        // Tab switching
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
            else {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(tabName)) btn.classList.add('active');
                });
            }
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Smart Auto Method
        async function smartLoadVideo() {
            if (!currentVideoUrl) return;
            const container = document.getElementById('smartContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                // Try blockquote first
                const blockquoteResult = await tryBlockquoteMethod();
                if (blockquoteResult.success) {
                    container.innerHTML = blockquoteResult.html;
                    await loadEmbedScript();
                    setTimeout(() => { forceReloadScript(); }, 200);
                    return;
                }

                // Try oEmbed
                const oembedResult = await tryOEmbedMethod();
                if (oembedResult.success) {
                    container.innerHTML = oembedResult.html;
                    await loadEmbedScript();
                    return;
                }

                // Fallback to external
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 2em; margin-bottom: 12px;">🔗</div>
                        <div><strong>Embed không khả dụng</strong></div>
                        <div style="margin: 12px 0; font-size: 0.9em;">Không thể nhúng video này. Vui lòng xem trực tiếp trên TikTok.</div>
                        <button onclick="window.open('${currentVideoUrl}', '_blank')" style="padding: 8px 16px; background: #ff0050; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight:600; font-size:0.9em;">
                            Mở video trên TikTok
                        </button>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 2em; margin-bottom: 12px;">❌</div>
                        <div>Lỗi khi tự động tải video</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Thử các tab khác hoặc dùng External</div>
                    </div>
                `;
            }
        }

        // Helper methods
        async function tryBlockquoteMethod() {
            try {
                return { success: true };
            } catch (error) {
                return { success: false };
            }
        }

        async function tryOEmbedMethod() {
            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const response = await fetch(oembedUrl);
                if (!response.ok) throw new Error();
                const data = await response.json();
                if (data && data.html) return { success: true };
                return { success: false };
            } catch (error) {
                return { success: false };
            }
        }

        async function loadOEmbed() {
            if (!currentVideoUrl) return;
            const container = document.getElementById('oembedContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const response = await fetch(oembedUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data && data.html) {
                    container.innerHTML = data.html;
                    await loadEmbedScript();
                } else {
                    throw new Error('No HTML in response');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 1.8em; margin-bottom: 10px;">❌</div>
                        <div>oEmbed API không khả dụng</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Lỗi: ${error.message}</div>
                    </div>
                `;
            }
        }

        async function tryOEmbedProxy() {
            const container = document.getElementById('oembedContainer');
            container.innerHTML = '<div class="loading-spinner"></div>';

            try {
                const oembedUrl = `https://www.tiktok.com/oembed?url=${encodeURIComponent(currentVideoUrl)}`;
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(oembedUrl)}`;
                
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data && data.html) {
                    container.innerHTML = data.html;
                    await loadEmbedScript();
                } else {
                    throw new Error('Không có HTML data');
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="error-container">
                        <div style="font-size: 1.8em; margin-bottom: 10px;">❌</div>
                        <div>CORS Proxy cũng thất bại</div>
                        <div style="font-size: 0.85em; margin-top: 8px;">Thử Blockquote method</div>
                    </div>
                `;
            }
        }

        async function loadBlockquote() {
            if (!currentVideoId || !currentVideoUrl) return;
            const container = document.getElementById('blockquoteContainer');
            
            const blockquoteHtml = `
                <blockquote class="tiktok-embed" 
                           cite="${currentVideoUrl}" 
                           data-video-id="${currentVideoId}" 
                           style="max-width: 100%; min-width: 280px; margin: 0 auto;">
                    <section>
                        <a target="_blank" href="${currentVideoUrl}">
                            Xem video TikTok này
                        </a>
                    </section>
                </blockquote>
            `;
            
            container.innerHTML = blockquoteHtml;
            await loadEmbedScript();
        }

        function forceReloadScript() {
            const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
            if (existingScript) {
                existingScript.remove();
            }
            embedScriptLoaded = false;
            loadBlockquote();
        }

        async function loadEmbedScript() {
            if (embedScriptLoaded) return;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://www.tiktok.com/embed.js';
                script.async = true;
                script.onload = () => {
                    embedScriptLoaded = true;
                    resolve();
                };
                script.onerror = () => {
                    reject(new Error('Script load failed'));
                };
                document.head.appendChild(script);
            });
        }

        function resetAllContainers() {
            document.getElementById('smartContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">🎯</div>
                    <div>Smart Auto sẽ tự động thử các phương pháp embed</div>
                    <div class="placeholder-note">Blockquote → oEmbed → External backup</div>
                </div>
            `;

            document.getElementById('oembedContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">🎬</div>
                    <div>TikTok oEmbed API</div>
                    <div class="placeholder-note">Phương thức chính thức từ TikTok</div>
                </div>
            `;

            document.getElementById('blockquoteContainer').innerHTML = `
                <div class="embed-placeholder">
                    <div class="placeholder-icon">📺</div>
                    <div>TikTok Blockquote</div>
                    <div class="placeholder-note">Native embed method</div>
                </div>
            `;
        }

        // Navigation functions
        function previousVideo() {
            if (currentVideoIndex > 0) {
                loadVideo(currentVideoIndex - 1);
            }
        }

        function nextVideo() {
            if (currentVideoIndex < csvData.length - 1) {
                loadVideo(currentVideoIndex + 1);
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.querySelector('.nav-btn.prev');
            const nextBtn = document.querySelector('.nav-btn.next');
            
            prevBtn.disabled = currentVideoIndex <= 0;
            nextBtn.disabled = currentVideoIndex >= csvData.length - 1;
        }

        // Label management
        function updateLabels() {
            if (currentVideoIndex >= 0 && currentVideoIndex < csvData.length) {
                const row = csvData[currentVideoIndex];
                
                row['Harmful Content'] = document.getElementById('harmfulContent').checked;
                row['Suicide'] = document.getElementById('suicide').checked;
                row['Adult Content'] = document.getElementById('adultContent').checked;
                row['Safe'] = document.getElementById('safe').checked;
                row['confuse'] = document.getElementById('confuse').checked;
                row['Empty'] = document.getElementById('empty').checked;

                displayVideoList();
                updateStats();
                
                hasUnsavedChanges = true;
                // Auto-save after label update
                autoSave();
            }
        }

        function updateStats() {
            const total = csvData.length;
            let labeled = 0;

            csvData.forEach(row => {
                const hasLabel = (
                    (row['Harmful Content'] === true || row['Harmful Content'] === 'true' || row['Harmful Content'] === '1') ||
                    (row['Suicide'] === true || row['Suicide'] === 'true' || row['Suicide'] === '1') ||
                    (row['Adult Content'] === true || row['Adult Content'] === 'true' || row['Adult Content'] === '1') ||
                    (row['Safe'] === true || row['Safe'] === 'true' || row['Safe'] === '1') ||
                    (row['confuse'] === true || row['confuse'] === 'true' || row['confuse'] === '1') ||
                    (row['Empty'] === true || row['Empty'] === 'true' || row['Empty'] === '1')
                );
                
                if (hasLabel) {
                    labeled++;
                }
            });

            const progress = total > 0 ? Math.round((labeled / total) * 100) : 0;

            document.getElementById('totalVideos').textContent = total;
            document.getElementById('labeledVideos').textContent = labeled;
            document.getElementById('progressPercent').textContent = progress + '%';
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Add auto-save function
        async function autoSave() {
            if (csvData.length === 0 || !hasUnsavedChanges) return;
            
            try {
                const csvContent = generateCSVContent();
                
                if (fileHandle) {
                    try {
                        const writable = await fileHandle.createWritable();
                        await writable.write(csvContent);
                        await writable.close();
                        lastSaveTime = new Date();
                        hasUnsavedChanges = false;
                        showNotification('💾 Đã tự động lưu!', 'success');
                    } catch (error) {
                        console.warn('Lỗi khi lưu file:', error);
                        fileHandle = null;
                        downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                    }
                } else if (permissionRequested) {
                    // Only download if permission was requested and denied
                    downloadCSV(csvContent, originalFile ? originalFile.name : 'labeled_tiktok_videos.csv');
                }
            } catch (error) {
                showNotification('❌ Lỗi khi tự động lưu: ' + error.message, 'error');
            }
        }

        // Helper function to generate CSV content
        function generateCSVContent() {
            const headers = Object.keys(csvData[0]);
            if (!headers.includes('Empty')) {
                headers.push('Empty');
            }
            let csvContent = headers.join(',') + '\n';

            csvData.forEach(row => {
                const values = headers.map(header => {
                    let value = row[header];
                    if (header === 'id_video' && value) {
                        value = String(value);
                    }
                    if (typeof value === 'boolean') {
                        value = value ? 'true' : 'false';
                    }
                    return `"${value}"`;
                });
                csvContent += values.join(',') + '\n';
            });

            return csvContent;
        }

        // Helper function to download CSV
        function downloadCSV(csvContent, filename) {
            try {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                lastSaveTime = new Date();
                hasUnsavedChanges = false;
                showNotification('💾 Đã lưu file tạm thời!', 'success');
            } catch (error) {
                showNotification('❌ Lỗi khi tải xuống file: ' + error.message, 'error');
            }
        }

        // Modify exportCSV to handle both file handle and download
        async function exportCSV() {
            if (csvData.length === 0) {
                alert('Không có dữ liệu để xuất!');
                return;
            }

            try {
                const csvContent = generateCSVContent();
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const defaultFilename = `labeled_tiktok_videos_${timestamp}.csv`;

                if (!permissionRequested) {
                    const granted = await showPermissionDialog();
                    permissionRequested = true;

                    if (granted) {
                        try {
                            const newFileHandle = await window.showSaveFilePicker({
                                suggestedName: defaultFilename,
                                types: [{
                                    description: 'CSV Files',
                                    accept: {'text/csv': ['.csv']},
                                }],
                            });

                            const writable = await newFileHandle.createWritable();
                            await writable.write(csvContent);
                            await writable.close();
                            showNotification('💾 Đã xuất CSV thành công!', 'success');
                            return;
                        } catch (error) {
                            console.warn('Không thể lưu file:', error);
                        }
                    }
                }

                // Fallback to download
                downloadCSV(csvContent, defaultFilename);
            } catch (error) {
                showNotification('❌ Lỗi khi xuất CSV: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (csvData.length === 0) return;

            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousVideo();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextVideo();
                    break;
                case '1':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('harmfulContent').click();
                    }
                    break;
                case '2':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('suicide').click();
                    }
                    break;
                case '3':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('adultContent').click();
                    }
                    break;
                case '4':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('safe').click();
                    }
                    break;
                case '5':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('confuse').click();
                    }
                    break;
                case '6':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        document.getElementById('empty').click();
                    }
                    break;
            }
        });

        async function loadGuideline() {
            try {
                const response = await fetch('Guideline.csv');
                const text = await response.text();
                const data = Papa.parse(text, {header: true, skipEmptyLines: true}).data;
                
                let notes = [];
                let html = '';
                const colors = ['#ffe7ba', '#ffd6e7', '#d6f5ff', '#e2ffe6'];
                const icons = ['🔞','⚠️','🆘','✅'];
                
                data.forEach((row, idx) => {
                    if (!row.Label) {
                        if (row.Defination) notes.push(row.Defination);
                        return;
                    }
                    
                    let videoHtml = '';
                    if (row.Link && row.Link.length > 5) {
                        let parts = row.Link.split('_');
                        if (parts.length === 2) {
                            let username = parts[0];
                            let vid = parts[1];
                            let tiktokUrl = `https://www.tiktok.com/@${username}/video/${vid}`;
                            videoHtml = `
                                <div style='margin-top:8px;'>
                                    <blockquote class="tiktok-embed" cite="${tiktokUrl}" data-video-id="${vid}" style="max-width: 280px; min-width: 200px; margin: 0 auto;">
                                        <section>
                                            <a target="_blank" href="${tiktokUrl}">Xem video ví dụ</a>
                                        </section>
                                    </blockquote>
                                </div>
                            `;
                        }
                    }
                    
                    html += `<div style="background:${colors[idx%colors.length]};border-radius:10px;padding:16px;min-width:200px;max-width:300px;box-shadow:0 2px 6px #0001;flex:1 1 240px;">
                        <div style='font-size:1.1em;font-weight:700;margin-bottom:6px;'>${icons[idx%icons.length]} ${row.Label}</div>
                        <div style='margin-bottom:6px;font-size:0.9em;'><b>Định nghĩa:</b> <span style='color:#333;'>${row.Defination}</span></div>
                        <div style='font-size:0.85em;'><b>Ví dụ:</b><br><span style='color:#555;'>${(row.Example||'').replace(/\\n/g, '<br>')}</span>${videoHtml}</div>
                    </div>`;
                });
                
                document.getElementById('guidelineCards').innerHTML = html;
                document.getElementById('guidelineNote').innerHTML = notes.map(n => `<div style='margin-bottom:3px;font-size:0.9em;'>${n}</div>`).join('');
                
                if (document.querySelector('.tiktok-embed')) {
                    const existingScript = document.querySelector('script[src*="tiktok.com/embed.js"]');
                    if (existingScript) existingScript.remove();
                    const script = document.createElement('script');
                    script.src = 'https://www.tiktok.com/embed.js';
                    script.async = true;
                    document.head.appendChild(script);
                }
            } catch (e) {
                document.getElementById('guidelineCards').innerHTML = '<i>Không thể tải guideline.</i>';
            }
        }

        // Initialize on load
        console.log('TikTok Video Labeling Tool v2.1 loaded successfully!');
        loadGuideline();

        // Accordion/collapsible logic
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.getElementById('accordionHeader');
            const content = document.getElementById('accordionContent');
            if (header && content) {
                header.addEventListener('click', function() {
                    header.classList.toggle('collapsed');
                    content.classList.toggle('collapsed');
                });
            }
        });

        // Add auto-save interval
        setInterval(() => {
            if (csvData.length > 0 && hasUnsavedChanges) {
                const now = new Date();
                if (!lastSaveTime || (now - lastSaveTime) > 300000) { // Auto-save every 5 minutes if there are changes
                    autoSave();
                }
            }
        }, 60000); // Check every minute

        // Add beforeunload event listener
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>